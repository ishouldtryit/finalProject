<?xml version="1.0" encoding="UTF-8"?>
<!-- ↑ XML 헤더 반드시 첫번째 줄에 위치 -->

<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
    

    <mapper namespace="approval">
   	   	<!-- 시퀀스 번호 생성 -->
   	    <select id="approvalSequence" resultType="int">
      	  select approval_seq.nextval from dual
    	</select>
    	
    	<select id="selectList" resultType="ApprovalDto">
    		select * from approval order by draft_no
    	</select>
    	
    	<select id="selectOne" resultType="ApprovalDto">
    		select * from approval where draft_no=#{draftNo}
    	</select>
    	
    	<insert id="insert" >
    		insert into approval( 
    		draft_no,draft_title,draft_content,
    		drafter_no, isemergency
    		) 
    		values(
    		#{draftNo},#{draftTitle},#{draftContent},
    		#{drafterNo}, #{isemergency}
    		)
    	</insert>
    	
    	<select id="search" resultType="ApprovalDto">
    		select * from approval where instr(${column}, #{keyword}) >0 order by ${column} asc
    	</select>

		<update id="editAllInOne">
			update approval
			<set>
				<if test="draftTitle!=null">
					draft_title=#{draftTitle},
				</if>
				<if test="draftContent!=null">
					draft_content=#{draftContent},
				</if>
			</set>
			where draft_no=#{draftNo}
		</update>    	
		
		<delete id="remove">
			delete approval where draft_no = #{draftNo}
		</delete>
    	
    	<!-- 결재자 추가 -->
    	<insert id="approverInsert">
    		insert into approver(
    		approver_no, draft_no, approver_order
    		)
    		values(
    		#{approverNo}, #{draftNo}, #{approverOrder}
    		)
    	</insert>
    	
    	<!-- 합의자 추가 -->
    	<insert id="agreeorInsert">
    		insert into agreeor(
    		agreeor_no, draft_no
    		)
    		values(
    		#{agreeorNo}, #{draftNo}
    		)
    	</insert>
    	
    	<!-- 참조자 추가 -->
    	<insert id="recipientInsert">
    		insert into recipient(
    		recipient_no, draft_no
    		)
    		values(
    		#{recipientNo}, #{draftNo}
    		)
    	</insert>
    	
    	<!-- 열람자 추가 -->
    	<insert id="readerInsert">
    		insert into reader(
    		reader_no, draft_no
    		)
    		values(
    		#{readerNo}, #{draftNo}
    		)
    	</insert>
    	
    	<!-- 계층형 조회 resultMap -->
		<resultMap type="ApprovalDataVO" id="ApprovalVO">
			<association property="approvalDto">
				<result column="draft_no" property="draftNo"/>
				<result column="draft_title" property="draftTitle"/>
				<result column="draft_content" property="draftContent"/>
				<result column="draft_date" property="draftDate"/>
				<result column="update_date" property="updateDate"/>
				<result column="drafter_no" property="drafterNo"/>
				<result column="status_code" property="statusCode"/>
				<result column="result_code" property="resultCode"/>
				<result column="return_reson" property="returnReson"/>
				<result column="isemergency" property="isemergency"/>
			</association>
			<collection property="approverList"
				javaType="java.util.List" ofType="approverDto "
				select="approverDataSelect"
				column="draft_no">
				<result column="approver_no" property="approverNo"/>
				<result column="approver_order" property="approverOrder"/>
				<result column="draft_no" property="draftNo"/>
			</collection>
			<collection property="agreeorList"
				javaType="java.util.List" ofType="agreeorDto "
				select="agreeorDataSelect"
				column="draft_no">
				<result column="agreeor_no" property="agreeorNo"/>
				<result column="draft_no" property="draftNo"/>
			</collection>
			<collection property="recipientList"
				javaType="java.util.List" ofType="recipientDto "
				select="recipientDataSelect"
				column="draft_no">
				<result column="recipient_no" property="recipientNo"/>
				<result column="draft_no" property="draftNo"/>
			</collection>
			<collection property="readerList"
				javaType="java.util.List" ofType="readerDto "
				select="readerDataSelect"
				column="draft_no">
				<result column="reader_no" property="readerNo"/>
				<result column="draft_no" property="draftNo"/>
			</collection>
		</resultMap>
		
		
		<!-- 계층형 조회 메인 구문 -->
		<select id="approvalDataSelect" resultMap="ApprovalDataVO">
			select*from approval order by draft_no desc
		</select>
		
		<!-- 계층형 조회 서브 구문 -->
		<select id="approverDataSelect" resultType="EmployeeDetailsDto">
			select * from employee_details where emp_no = #{approverNo}
			order by approver_order asc
		</select>
    	
    </mapper>